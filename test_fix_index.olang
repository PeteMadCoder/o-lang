// External C functions
fn strlen(*byte str) -> int;
fn memcpy(*byte dest, *byte src, int n) -> *void;
fn malloc(int size) -> *byte;
fn printf(*byte str);

struct String {
    *byte buffer;
    int length;

    new(*char ptr) {
        unsafe {
            this.length = strlen(ptr);
            this.buffer = malloc(this.length + 1);
            memcpy(this.buffer, ptr, this.length);
            var end_ptr = &this.buffer[this.length];
            *end_ptr = 0;
        }
    }

    fn op_index(int idx) -> int {
        unsafe {
            var byte_ptr = &this.buffer[idx];
            var byte_val = *byte_ptr;
            // Explicit cast from byte to int
            var int_val = 0;
            int_val = byte_val;
            return int_val;
        }
    }
}

fn main() -> int {
    var s = new String("Hello");
    var c = s[1];
    
    unsafe {
        if (c == 101) {
            printf("SUCCESS: got 'e'\n");
        } else {
            printf("FAILED\n");
        }
    }
    
    return 0;
}
