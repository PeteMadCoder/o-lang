// External C functions
fn strlen(*byte str) -> int;
fn memcpy(*byte dest, *byte src, int n) -> *void;
fn malloc(int size) -> *byte;
fn free(*byte ptr);
fn printf(*byte str, ...);

// Simple String class with operator overloading
struct String {
    *byte buffer;
    int length;

    new(*char ptr) {
        var len = 0;
        unsafe {
            len = strlen(ptr);
        }
        
        this.length = len;
        
        unsafe {
            this.buffer = malloc(len + 1);
            memcpy(this.buffer, ptr, len);
            var end_ptr = &this.buffer[len];
            *end_ptr = 0;
        }
    }

    fn op_add(*String other) -> *String {
        var new_len = this.length + other.length;
        var result = new String("");
        result.length = new_len;
        
        unsafe {
            free(result.buffer);
            result.buffer = malloc(new_len + 1);
            
            memcpy(result.buffer, this.buffer, this.length);
            var dest = &result.buffer[this.length];
            memcpy(dest, other.buffer, other.length);
            
            var end = &result.buffer[new_len];
            *end = 0;
        }
        
        return result;
    }

    fn op_index(int idx) -> int {
        unsafe {
            var ptr = &this.buffer[idx];
            return *ptr;
        }
    }
}

fn main() -> int {
    var s1 = new String("Hello");
    var s2 = new String(" World!");
    
    // Test operator overloading: +
    var s3 = s1 + s2;
    
    unsafe {
        printf(s3.buffer);
        printf("\n");
    }
    
    // Test operator overloading: []
    var c = s1[1]; // Should be 'e' (101)
    
    unsafe {
        printf("Character at index 1: %d\n", c);
    }
    
    return 0;
}
